<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script>
        // private namespacing
        var StudyNS = {
          // 0 for lucid
          // 1 for red
          // 2 for yellow
          badgeColor: 1,
          // zoom percentage; 100% is full zoom
          zoom: 80,
          // noFrames config - do not disable
          adjustFrameWidth: true,
          // if debug is set, logging is enabled and recorded results are populated in the results page
          debug: false,
          // some default device name - unfortunately only nexus is supported now, since we don't have frames for other phones
          deviceName: "nexus5",
          fileLocation: ["adsui-server", "x20"],
          // filelocation 0 for adsui-server and 1 for x20 (removed x20 support, code should be cleaned)
          fileLocationChoice: 0,
          parentLocation: null,
          adsuiBaseLocation: "https://adsui-mturk-pages.appspot.com/public/",
          pagesDirName: ["pages", "pages-noscript"],
          // modify pages dir choice here; 0 for pages; 1 for pages-without-script-tags
          pagesDirChoice: 1,
          // use modified scraped pages with removed script tags and event handlers or original scraped pages
          useModifiedPages: true,
          // query map for the modal
          queryMap: {
                      cheapcarinsurance: "cheap car insurance",
                      invisalign: "invisalign",
                      plumbersnearme: "plumbers near me",
                      prepaidcards: "prepaid cards",
                      taxesonline: "taxes online",
                    },
          // do not change, currently only nexus frame is available, it won't scale for other values
          phoneScreenDimensions: { height: 737, width: 412 },
          // will be auto-initialized to contain iframe information
          pages: null,
          // will be auto-initialized to contain query information
          queryPrefixes: null,
          // these are all the different combinations of VCAP size and Top Ad count available
          querySuffixes: [
                          "3_636",
                           // "3_780",
                           // "4_1068",
                           // "4_780",
                           // "4_924",
                           "5_1068",
                           // "5_924"
                          ],
          // represents number of rounds of tasks
          // Maximum allowed rounds should be 7 (because we have only that many different query suffixes)
          maxRounds: 2,
          // represents the current round, initially zero
          currentRound: 0,
          // where the scraped pages live
          scrapedPagesOrigin: "https://adsui-mturk-pages.appspot.com",
          // studyData will be a two dimensional array [roundNo][pageNo], it will be auto-initialized later
          studyData: {
                        roundData: [[],[]],
                        responseData: {},
                        clientInfo: {userAgent: "", screenHeight: -1, screenWidth: -1, browserHeight: -1, browserWidth: -1, ipHash: ""},
                      },
          // state represents the different available states for the page
          state: {
                    CONSENT: "consent",
                    INSTRUCTIONS: "instructions",
                    STUDY: "study",
                    QUESTIONNAIRE: "questionnaire",
                    FINAL: "final",
                    RESULT: "result",
                  },
          // represents the global state, will be auto-initialized to CONSENT
          global_state: null,
          // current iFrameCount, initially zero
          iFrameCount: 0,
          // browser name - will be auto-initialized
          browser: "",
          // operating system - will be auto-initialized
          os: "",
          //badge color map
          badgeColorMap: ["lucid", "red", "yellow"],
        };

        function initQueryPrefixes(){
          StudyNS.queryPrefixes = [
            StudyNS.fileLocation[StudyNS.fileLocationChoice]=="x20"
            ? (StudyNS.parentLocation
            + StudyNS.pagesDirName[StudyNS.pagesDirChoice]
            + "/cheap_car_insurance/cheapcarinsurance_mobile_")
            : (StudyNS.adsuiBaseLocation + "cheapcarinsurance_mobile_"),

            StudyNS.fileLocation[StudyNS.fileLocationChoice]=="x20"
            ? (StudyNS.parentLocation
            + StudyNS.pagesDirName[StudyNS.pagesDirChoice]
            + "/invisalign/invisalign_mobile_")
            : (StudyNS.adsuiBaseLocation + "invisalign_mobile_"),

            StudyNS.fileLocation[StudyNS.fileLocationChoice]=="x20"
            ? (StudyNS.parentLocation
            + StudyNS.pagesDirName[StudyNS.pagesDirChoice]
            + "/plumbers_near_me/plumbersnearme_mobile_")
            : (StudyNS.adsuiBaseLocation + "plumbersnearme_mobile_"),

            StudyNS.fileLocation[StudyNS.fileLocationChoice]=="x20"
            ? (StudyNS.parentLocation
            + StudyNS.pagesDirName[StudyNS.pagesDirChoice]
            + "/prepaid_cards/prepaidcards_mobile_")
            : (StudyNS.adsuiBaseLocation + "prepaidcards_mobile_"),

            StudyNS.fileLocation[StudyNS.fileLocationChoice]=="x20"
            ? (StudyNS.parentLocation
            + StudyNS.pagesDirName[StudyNS.pagesDirChoice]
            + "/taxes_online/taxesonline_mobile_")
            : (StudyNS.adsuiBaseLocation + "taxesonline_mobile_"),
          ];
        }

        function initPagesAndStudyData() {
            StudyNS.pages = [];
            for (var i = 0; i < StudyNS.queryPrefixes.length; ++i) {
                StudyNS.pages.push([]);
            }

            // StudyNS.studyData = [];
            // for (var i = 0; i < StudyNS.maxRounds; ++i) {
            // StudyNS.studyData.push([]);
            // }
        }

        function getUpdatedQuerySuffix(oldQuerySuffix) {
          var updatedQuerySuffix = oldQuerySuffix;
          if(StudyNS.useModifiedPages){
             updatedQuerySuffix = updatedQuerySuffix + "_modified";
          }
          // add badge color specific suffix
          var choiceOfBadgeColor = StudyNS.badgeColorMap[StudyNS.badgeColor];
          if(!choiceOfBadgeColor){
            choiceOfBadgeColor = "lucid";
          }
          updatedQuerySuffix = updatedQuerySuffix + "_" + choiceOfBadgeColor + "-badge";
          // adjust frame width?
          if(StudyNS.adjustFrameWidth){
            updatedQuerySuffix = updatedQuerySuffix + "_no-frames";
          }
          // add .html file extension
          updatedQuerySuffix = updatedQuerySuffix + ".html";

          return updatedQuerySuffix;
        }

        function setupTreatment() {
            // initializing Pages and studyData
            initPagesAndStudyData();
            var choiceOfQuerySuffix = StudyNS.querySuffixes.splice(getRandomInt(StudyNS.querySuffixes.length), 1);
            fillPagesWithQuerySuffix(getUpdatedQuerySuffix(choiceOfQuerySuffix), 0);

            for(var i = 1; i < StudyNS.maxRounds; ++i) {
              //modify treatment with 50% probability for next round
              if (getRandomInt(2) == 0) {
                  log("using same load for round 2", getUpdatedQuerySuffix(choiceOfQuerySuffix));
                  fillPagesWithQuerySuffix(getUpdatedQuerySuffix(choiceOfQuerySuffix), i);
              } else {
                  choiceOfQuerySuffix = StudyNS.querySuffixes.splice(getRandomInt(StudyNS.querySuffixes.length), 1);
                  log("using different load for round 2", getUpdatedQuerySuffix(choiceOfQuerySuffix));
                  fillPagesWithQuerySuffix(getUpdatedQuerySuffix(choiceOfQuerySuffix), i);
              }
            }
        }

        initQueryPrefixes();
        log("queryPrefixes: ", StudyNS.queryPrefixes);
        setupTreatment();



        function fillPagesWithQuerySuffix(querySuffix, runIndex) {
            log("Filling Pages with Query Suffix", querySuffix);
            for (var i = 0; i < StudyNS.queryPrefixes.length; ++i) {
                StudyNS.pages[i][runIndex] = StudyNS.queryPrefixes[i] + querySuffix;
            }
        }

        function getPropertiesFromUrl(url) {
            var queryParams = (url.substring(url.lastIndexOf('/') + 1, url.lastIndexOf('.'))).split('_');
            var properties = {
                query: StudyNS.queryMap[queryParams[0]],
                vCap: queryParams[3],
                topAds: queryParams[2]
            };
            return properties;
        }

        // returns an integer between [0, max)
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function ClickData(contentType, contentPosition, clickedElement) {
            this.contentType = contentType;
            this.contentPosition = contentPosition;
            // below elements are for logical purposes and are not printed out
            this.clickedElement = clickedElement;
        }

        function PageData(query, vCap, topAds, clickData, maxScrollDistance, timeTakenMS, round) {
            this.query = query;
            this.vCap = vCap;
            this.topAds = topAds;
            this.clickData = clickData;
            this.maxScrollDistance = maxScrollDistance;
            this.timeTakenMS = timeTakenMS;
            this.round = round;
        }

        // strictly use this logging as opposed to console.log
        function log(text, object) {
            if (StudyNS.debug) {
                if (object == undefined) {
                    console.log(text);
                } else {
                    console.log(text, object);
                }
            }
        }

      //for testing purpose, remove when code is ready
      window.addEventListener("message", function(event){
        log("received message", event.data);
        var eventData = event.data;
        if(eventData.type == "result"){
         //result data
         var iFrameResultData = eventData.iFrameResultData;
         var clickData = iFrameResultData.clickData;
         //for now not using timestamp and maxscroll distance even though they are already available
         resultElementActions(clickData.contentType, clickData.contentPosition, clickData.element, iFrameResultData.timeStamp, iFrameResultData.maxScrollDistance);
        }
      });

      function getHash(str){
        var hash = 0;
        var max = Math.pow(2,31) - 1;
        for (var i = 0; i < str.length; i++) {
            hash = (hash + (Math.pow(str.charCodeAt(i) * 31, str.length - i) % max)) % max;
        }
        return hash;
      }

      // trying to get client ip
      function getIP(json) {
        if(StudyNS.studyData.clientInfo.ipHash == ""){
         StudyNS.studyData.clientInfo.ipHash = getHash(json.ip);
        }
      }
    </script>
    <script type="application/javascript" src="https://api.ipify.org?format=jsonp&callback=getIP"></script>
    <style>
        body {
            background-color: #f8f9fa;
            line-height: 1.6;
        }

        .generic-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.125);
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, .05);
            border-radius: 0.25rem;
        }

        .study-content {
            position: relative;
            min-width: 556px;
        }

        .generic-content-box {
            margin: 40px;
            text-align: center;
        }

        #study-button-wrapper {
            margin: 40px;
        }

        .btn {
            background-color: #fff;
            text-align: center;
            border: 1px solid #ccc;
            margin: 10px;
            padding: 10px;
            width: 250px;
        }

        .iframe {
          position:fixed;
          top:0px;
          left:0px;
          bottom:0px;
          right:0px;
          width:100%;
          height:100%;
          border:none;
          margin:0;
          padding:0;
          overflow:hidden;
          z-index:999999;
        }

        .current-state {
            display: block;
        }

        .background-state {
            display: none;
        }

        #instructions-content-box {
            text-align: left;
        }

        #instructions-button-wrapper {
            text-align: center;
        }

        #instructions-content-box h1 {
            text-align: center;
        }

        .load-only {
         display: none;
        }
    </style>
</head>

<body>
<!--     preload image -->
  <img src="https://adsui-mturk-pages.appspot.com/public/nexus5-portrait.png" class="load-only">
    <section id="consent" class="background-state">
        <div id="consent-content" class="generic-content">
            <div id="consent-content-box" class="generic-content-box">
                <p>
                    Your participation in this study, including what you see and how you respond, is a confidential communication between you and the authors of the study.
                </p>
                <p>
                    By taking this study, you agree not to share anything related to this study with others.
                </p>
                <div id="consent-button-wrapper">
                    <button id="agree-btn" class="btn">Agree and Continue</button>
                    <form method="GET" action="https://www.mturk.com/mturk/searchbar?requesterId=A11L036EBWKONR">
                        <button class="btn" id="disagree-btn" type="submit">Disagree</button>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- End of consent state -->

    <section id="instructions" class="background-state">
        <div id="instructions-content" class="generic-content">
            <div id="instructions-content-box" class="generic-content-box">
                <h1>
          <b>Instructions</b>
        </h1>
                <p>This study has a series of rounds. Each round consists of 5 tasks, in each task:</p>
                <ul>
                    <li>
                        <p>First, you will be assigned a product or service.
                            <br> Imagine that you wanted to buy this product or service.</p>
                    </li>
                    <li>
                        <p>Next, you will view a page of links for the product or service.
                            <br> Read the page and click on the link that you think is best.</p>
                    </li>
                </ul>
                <p>At the end of each round, you will be asked to answer two brief questions about your experience reading the pages.</p>
                <div id="instructions-button-wrapper">
                    <button id="start-btn" class="btn">Start Round 1</button>
                </div>
            </div>
        </div>
    </section>
    <!-- End of instructions state -->

    <section id="study" class="background-state">
        <div id="pre-study-content" class="generic-content" style="display: none;">
            <div id="pre-study-content-box" class="generic-content-box">
                <p style="font-size: large;">Imagine that you want to research <b><span id="query">a query</span></b>. Read the page and click on the best link.</p>
                <div id="ok-button-wrapper">
                    <button class="btn" id="ok-btn">Proceed</button>
                </div>
            </div>
        </div>
        <div id="study-content" class="study-content" style="display: none;">
            <div id="study-content-box" class="generic-content-box">
                <div id="individual-study">
                    <div id="iframe-frame">
                        <div id="iframe-wrapper">
                            <div id="iframe-parent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End of study-content-box -->
        </div>
        <!-- End of study-content -->
    </section>
    <!-- End of study state -->

    <!-- Start of Questionnaire State: The questionnaire state will have two binary answer questions -->
    <section id="questionnaire" class="background-state">
        <div id="questionnaire-content" class="generic-content">
            <div id="questionnaire-content-box" class="generic-content-box">
                <div id="relevant-box">
                    <h2>Were the results relevant?</h2>
                    <div id="questionnaire-button-wrapper">
                        <button class="btn" id="yes-btn">Yes</button>
                        <button class="btn" id="no-btn">No</button>
                    </div>
                </div>
                <div id="reasonable-box" style="display: none;">
                    <h2>Were the ads reasonable?</h2>
                    <div id="questionnaire-button-wrapper-2">
                        <button class="btn" id="yes-btn-2">Yes</button>
                        <button class="btn" id="no-btn-2">No</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="lets-go-again-content" class="generic-content" style="display: none">
            <div id="lets-go-again-content-box" class="generic-content-box">
                <h2>Round 2</h2>
                <div id="lets-go-again-button-wrapper">
                    <button class="btn" id="go-btn">Go</button>
                </div>
            </div>
        </div>
    </section>
    <!-- End of "Questionnaire" State -->
    <!-- Start of the "Final" State -->
    <section id="final" class="background-state">
        <div id="final-content" class="generic-content">
            <div id="final-content-box" class="generic-content-box">
                <h2>Did you find any difference between the two rounds?</h2>
                <div id="final-button-wrapper">
                    <button class="btn" id="final-yes-btn">Yes</button>
                    <button class="btn" id="final-no-btn">No</button>
                </div>
            </div>
        </div>
        <div id="diff-desc-content" class="generic-content" style="display: none">
            <div id="diff-desc-content-box" class="generic-content-box">
                <h3>Please describe</h3>
                <div id="text-area-wrapper">
                    <!-- Turker will describe visible difference here -->
                    <textarea id="diff-desc-textarea" rows="4" cols="55" maxlength="200"></textarea>
                </div>
                <div id="diff-desc-button-wrapper">
                    <button class="btn" id="submit-btn">Submit</button>
                </div>
            </div>
        </div>
    </section>
    <!-- End of the "Final" State -->
    <!--Start of result state -->
    <section id="result" class="background-state">
        <div id="result-content" class="generic-content" style="display: none">
          <div id="result-content-box" class="generic-content-box">
            <div id="result-form">
              <form method="POST" action="https://www.google.com/evaluation/endor/submit">
                <p>Thank for you your responses.</p>
                <p>Please press <em>Submit</em> to complete the survey.</p>
                <input type="hidden" name="taskId" value="${taskId}">
                <input type="hidden" id="surveyData" name="surveyData" value="">
                <button type="submit" value="Submit" id="submit" class="btn">Submit</button>
              </form>
            </div>
          </div>
        </div>
    </section>
    <!-- End of result state-->

    <script>
        function strContains(str, target) {
          return str.indexOf(target) >= 0;
        }

        function startStudy(){
          //add event listners to all states in outer document
            addConsentStateListeners();
            addInstructionsStateListeners();
            addStudyStateListeners();
            addQuestionnaireStateListeners();
            addFinalStateListeners();

            //set-up IFrame Wrapper dimensions
            //setupIFrameWrapperDimensions();

            //start loading all iframes behind the screen
            loadAllIFrames();

            //update display
            StudyNS.global_state = StudyNS.state.CONSENT;
            showState(StudyNS.state.CONSENT);
        }

        // defines browser detection library
        function init(){
          !function(window,undefined){"use strict";var EMPTY="",UNKNOWN="?",FUNC_TYPE="function",UNDEF_TYPE="undefined",OBJ_TYPE="object",MAJOR="major",MODEL="model",NAME="name",TYPE="type",VENDOR="vendor",VERSION="version",ARCHITECTURE="architecture",CONSOLE="console",MOBILE="mobile",TABLET="tablet";var util={has:function(str1,str2){return str2.toLowerCase().indexOf(str1.toLowerCase())!==-1},lowerize:function(str){return str.toLowerCase()}};var mapper={rgx:function(){for(var result,i=0,j,k,p,q,matches,match,args=arguments;i<args.length;i+=2){var regex=args[i],props=args[i+1];if(typeof result===UNDEF_TYPE){result={};for(p in props){q=props[p];if(typeof q===OBJ_TYPE){result[q[0]]=undefined}else{result[q]=undefined}}}for(j=k=0;j<regex.length;j++){matches=regex[j].exec(this.getUA());if(!!matches){for(p in props){match=matches[++k];q=props[p];if(typeof q===OBJ_TYPE&&q.length>0){if(q.length==2){if(typeof q[1]==FUNC_TYPE){result[q[0]]=q[1].call(this,match)}else{result[q[0]]=q[1]}}else if(q.length==3){if(typeof q[1]===FUNC_TYPE&&!(q[1].exec&&q[1].test)){result[q[0]]=match?q[1].call(this,match,q[2]):undefined}else{result[q[0]]=match?match.replace(q[1],q[2]):undefined}}else if(q.length==4){result[q[0]]=match?q[3].call(this,match.replace(q[1],q[2])):undefined}}else{result[q]=match?match:undefined}}break}}if(!!matches)break}return result},str:function(str,map){for(var i in map){if(typeof map[i]===OBJ_TYPE&&map[i].length>0){for(var j=0;j<map[i].length;j++){if(util.has(map[i][j],str)){return i===UNKNOWN?undefined:i}}}else if(util.has(map[i],str)){return i===UNKNOWN?undefined:i}}return str}};var maps={browser:{oldsafari:{major:{1:["/8","/1","/3"],2:"/4","?":"/"},version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2000:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",RT:"ARM"}}}};var regexes={browser:[[/(opera\smini)\/((\d+)?[\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/((\d+)?[\w\.-]+)/i,/(opera).+version\/((\d+)?[\w\.]+)/i,/(opera)[\/\s]+((\d+)?[\w\.]+)/i],[NAME,VERSION,MAJOR],[/\s(opr)\/((\d+)?[\w\.]+)/i],[[NAME,"Opera"],VERSION,MAJOR],[/(kindle)\/((\d+)?[\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?((\d+)?[\w\.]+)*/i,/(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?((\d+)?[\w\.]*)/i,/(?:ms|\()(ie)\s((\d+)?[\w\.]+)/i,/(rekonq)((?:\/)[\w\.]+)*/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron)\/((\d+)?[\w\.-]+)/i],[NAME,VERSION,MAJOR],[/(trident).+rv[:\s]((\d+)?[\w\.]+).+like\sgecko/i],[[NAME,"IE"],VERSION,MAJOR],[/(yabrowser)\/((\d+)?[\w\.]+)/i],[[NAME,"Yandex"],VERSION,MAJOR],[/(comodo_dragon)\/((\d+)?[\w\.]+)/i],[[NAME,/_/g," "],VERSION,MAJOR],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?((\d+)?[\w\.]+)/i],[NAME,VERSION,MAJOR],[/(dolfin)\/((\d+)?[\w\.]+)/i],[[NAME,"Dolphin"],VERSION,MAJOR],[/((?:android.+)crmo|crios)\/((\d+)?[\w\.]+)/i],[[NAME,"Chrome"],VERSION,MAJOR],[/version\/((\d+)?[\w\.]+).+?mobile\/\w+\s(safari)/i],[VERSION,MAJOR,[NAME,"Mobile Safari"]],[/version\/((\d+)?[\w\.]+).+?(mobile\s?safari|safari)/i],[VERSION,MAJOR,NAME],[/webkit.+?(mobile\s?safari|safari)((\/[\w\.]+))/i],[NAME,[MAJOR,mapper.str,maps.browser.oldsafari.major],[VERSION,mapper.str,maps.browser.oldsafari.version]],[/(konqueror)\/((\d+)?[\w\.]+)/i,/(webkit|khtml)\/((\d+)?[\w\.]+)/i],[NAME,VERSION,MAJOR],[/(navigator|netscape)\/((\d+)?[\w\.-]+)/i],[[NAME,"Netscape"],VERSION,MAJOR],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?((\d+)?[\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix)\/((\d+)?[\w\.-]+)/i,/(mozilla)\/((\d+)?[\w\.]+).+rv\:.+gecko\/\d+/i,/(uc\s?browser|polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|qqbrowser)[\/\s]?((\d+)?[\w\.]+)/i,/(links)\s\(((\d+)?[\w\.]+)/i,/(gobrowser)\/?((\d+)?[\w\.]+)*/i,/(ice\s?browser)\/v?((\d+)?[\w\._]+)/i,/(mosaic)[\/\s]((\d+)?[\w\.]+)/i],[NAME,VERSION,MAJOR]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[ARCHITECTURE,"amd64"]],[/((?:i[346]|x)86)[;\)]/i],[[ARCHITECTURE,"ia32"]],[/windows\s(ce|mobile);\sppc;/i],[[ARCHITECTURE,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[ARCHITECTURE,/ower/,"",util.lowerize]],[/(sun4\w)[;\)]/i],[[ARCHITECTURE,"sparc"]],[/(ia64(?=;)|68k(?=\))|arm(?=v\d+;)|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[ARCHITECTURE,util.lowerize]],device:[[/\((ipad|playbook);[\w\s\);-]+(rim|apple)/i],[MODEL,VENDOR,[TYPE,TABLET]],[/(hp).+(touchpad)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[VENDOR,MODEL,[TYPE,TABLET]],[/\((ip[honed]+);.+(apple)/i],[MODEL,VENDOR,[TYPE,MOBILE]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|huawei|meizu|motorola)[\s_-]?([\w-]+)*/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/\((bb10);\s(\w+)/i],[[VENDOR,"BlackBerry"],MODEL,[TYPE,MOBILE]],[/android.+((transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+))/i],[[VENDOR,"Asus"],MODEL,[TYPE,TABLET]],[/(sony)\s(tablet\s[ps])/i],[VENDOR,MODEL,[TYPE,TABLET]],[/(nintendo)\s([wids3u]+)/i],[VENDOR,MODEL,[TYPE,CONSOLE]],[/((playstation)\s[3portablevi]+)/i],[[VENDOR,"Sony"],MODEL,[TYPE,CONSOLE]],[/(sprint\s(\w+))/i],[[VENDOR,mapper.str,maps.device.sprint.vendor],[MODEL,mapper.str,maps.device.sprint.model],[TYPE,MOBILE]],[/(htc)[;_\s-]+([\w\s]+(?=\))|\w+)*/i,/(zte)-(\w+)*/i,/(alcatel|geeksphone|huawei|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]+)*/i],[VENDOR,[MODEL,/_/g," "],[TYPE,MOBILE]],[/\s((milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?(:?\s4g)?))[\w\s]+build\//i,/(mot)[\s-]?(\w+)*/i],[[VENDOR,"Motorola"],MODEL,[TYPE,MOBILE]],[/android.+\s((mz60\d|xoom[\s2]{0,2}))\sbuild\//i],[[VENDOR,"Motorola"],MODEL,[TYPE,TABLET]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n8000|sgh-t8[56]9))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,TABLET]],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)*/i,/sec-((sgh\w+))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,MOBILE]],[/(sie)-(\w+)*/i],[[VENDOR,"Siemens"],MODEL,[TYPE,MOBILE]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]+)*/i],[[VENDOR,"Nokia"],MODEL,[TYPE,MOBILE]],[/android\s3\.[\s\w-;]{10}((a\d{3}))/i],[[VENDOR,"Acer"],MODEL,[TYPE,TABLET]],[/android\s3\.[\s\w-;]{10}(lg?)-([06cv9]{3,4})/i],[[VENDOR,"LG"],MODEL,[TYPE,TABLET]],[/((nexus\s4))/i,/(lg)[e;\s-\/]+(\w+)*/i],[[VENDOR,"LG"],MODEL,[TYPE,MOBILE]],[/(mobile|tablet);.+rv\:.+gecko\//i],[TYPE,VENDOR,MODEL]],engine:[[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[NAME,VERSION],[/rv\:([\w\.]+).*(gecko)/i],[VERSION,NAME]],os:[[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*|windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],[NAME,[VERSION,mapper.str,maps.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[NAME,"Windows"],[VERSION,mapper.str,maps.os.windows.version]],[/\((bb)(10);/i],[[NAME,"BlackBerry"],VERSION],[/(blackberry)\w*\/?([\w\.]+)*/i,/(tizen)\/([\w\.]+)/i,/(android|webos|palm\os|qnx|bada|rim\stablet\sos|meego)[\/\s-]?([\w\.]+)*/i],[NAME,VERSION],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]+)*/i],[[NAME,"Symbian"],VERSION],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[NAME,"Firefox OS"],VERSION],[/(nintendo|playstation)\s([wids3portablevu]+)/i,/(mint)[\/\s\(]?(\w+)*/i,/(joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)[\/\s-]?([\w\.-]+)*/i,/(hurd|linux)\s?([\w\.]+)*/i,/(gnu)\s?([\w\.]+)*/i],[NAME,VERSION],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[NAME,"Chromium OS"],VERSION],[/(sunos)\s?([\w\.]+\d)*/i],[[NAME,"Solaris"],VERSION],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]+)*/i],[NAME,VERSION],[/(ip[honead]+)(?:.*os\s*([\w]+)*\slike\smac|;\sopera)/i],[[NAME,"iOS"],[VERSION,/_/g,"."]],[/(mac\sos\sx)\s?([\w\s\.]+\w)*/i],[NAME,[VERSION,/_/g,"."]],[/(haiku)\s(\w+)/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.]*)*/i,/(macintosh|mac(?=_powerpc)|plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos)/i,/(unix)\s?([\w\.]+)*/i],[NAME,VERSION]]};var UAParser=function(uastring){var ua=uastring||(window&&window.navigator&&window.navigator.userAgent?window.navigator.userAgent:EMPTY);if(!(this instanceof UAParser)){return new UAParser(uastring).getResult()}this.getBrowser=function(){return mapper.rgx.apply(this,regexes.browser)};this.getCPU=function(){return mapper.rgx.apply(this,regexes.cpu)};this.getDevice=function(){return mapper.rgx.apply(this,regexes.device)};this.getEngine=function(){return mapper.rgx.apply(this,regexes.engine)};this.getOS=function(){return mapper.rgx.apply(this,regexes.os)};this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}};this.getUA=function(){return ua};this.setUA=function(uastring){ua=uastring;return this};this.setUA(ua)};if(typeof exports!==UNDEF_TYPE){if(typeof module!==UNDEF_TYPE&&module.exports){exports=module.exports=UAParser}exports.UAParser=UAParser}else{window.UAParser=UAParser;if(typeof define===FUNC_TYPE&&define.amd){define(function(){return UAParser})}if(typeof window.jQuery!==UNDEF_TYPE){var $=window.jQuery;var parser=new UAParser;$.ua=parser.getResult();$.ua.get=function(){return parser.getUA()};$.ua.set=function(uastring){parser.setUA(uastring);var result=parser.getResult();for(var prop in result){$.ua[prop]=result[prop]}}}}}(this);
        }

        document.addEventListener("DOMContentLoaded", function(event) {
          init();
          // Browser support detection.
          var parser = new UAParser();
          var os = parser.getOS().name;
          var userAgent = "" + parser.getUA();
          if (os === "Android"
              || os === "iOS"
              || os === "Windows Mobile"
              || os === "BlackBerry"
              || os === "RIM Tablet OS"
              || os === "Symbian"
              || os === "Windows Phone OS") {
            alert("This HIT must be completed on a desktop or laptop computer. Tablets and other mobile devices are not allowed.");
          } else if ((strContains(userAgent, "MSIE ") && !strContains(userAgent, "MSIE 1")) ||
              typeof JSON != 'object' ||
              !('stringify' in JSON)) {
            alert("Your current browser is not supported. Please upgrade to the latest version, or use the Google Chrome browser instead.");
          } else if (strContains(window.location.search, "assignmentId=ASSIGNMENT_ID_NOT_AVAILABLE")) {
            alert("To begin the test, you must first accept this HIT.");
          } else {
            StudyNS.browser = userAgent;
            StudyNS.os = os;
            startStudy();
          }
        });

        function addConsentStateListeners() {
            document.getElementById("agree-btn").onclick = function(event) {
                event.stopPropagation();
                transitionToNextState();
            };
        }

        function addInstructionsStateListeners() {
            document.getElementById("start-btn").onclick = function(event) {
                event.stopPropagation();
                transitionToNextState();
                showModal();
            };
        }

        function addStudyStateListeners() {
            document.getElementById("ok-btn").onclick = function(event) {
                log("proceed button has been clicked");
                event.stopPropagation();
                hideModal(); //also takes care of showing the study-contentBox
                transitionToNextIFrame();
            };
        }

        function addQuestionnaireStateListeners() {
            document.getElementById("yes-btn").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["results_relevant_round_"+StudyNS.currentRound] = true;
                document.getElementById("relevant-box").style.display = "none";
                document.getElementById("reasonable-box").style.display = "";
            };

            document.getElementById("no-btn").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["results_relevant_round_"+StudyNS.currentRound] = false;
                document.getElementById("relevant-box").style.display = "none";
                document.getElementById("reasonable-box").style.display = "";
            };

            document.getElementById("yes-btn-2").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["ads_reasonable_round_"+StudyNS.currentRound] = true;
                transitionToNextState();
                //return to normal state
                document.getElementById("reasonable-box").style.display = "none";
                document.getElementById("relevant-box").style.display = "";
            };

            document.getElementById("no-btn-2").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["ads_reasonable_round_"+StudyNS.currentRound] = false;
                transitionToNextState();
                //return to normal state
                document.getElementById("reasonable-box").style.display = "none";
                document.getElementById("relevant-box").style.display = "";
            }
        }

        function addFinalStateListeners() {
            document.getElementById("final-yes-btn").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["found_difference"] = true;
                //ask for the difference
                hideElement(getFinalContent());
                var diffDescContent = getDiffDescContent();
                showElement(diffDescContent);
                //auto focus text area
                getDiffDescTextArea().focus();
            };

            document.getElementById("final-no-btn").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["found_difference"] = false;
                transitionToNextState();
            }

            document.getElementById("go-btn").onclick = function(event) {
                event.stopPropagation();
                log("going back to the study state for round 2");
                hideState(StudyNS.state.QUESTIONNAIRE);
                //go back to study state
                StudyNS.global_state = StudyNS.state.STUDY;
                showState(StudyNS.state.STUDY);
                //let the questionnaire state get back to how it was
                hideElement(getLetsGoAgainContent());
                showElement(getQuestionnaireContent());
            }

            document.getElementById("submit-btn").onclick = function(event) {
                event.stopPropagation();
                StudyNS.studyData.responseData["difference_description"] = getDiffDescTextArea().value;
                transitionToNextState();
                //get the final state back to normal
                hideElement(getDiffDescContent());
                showElement(getFinalContent());
            }
        }



        function transitionToNextState() {
            if (StudyNS.global_state == StudyNS.state.CONSENT) {
                hideState(StudyNS.state.CONSENT);
                StudyNS.global_state = StudyNS.state.INSTRUCTIONS;
                showState(StudyNS.state.INSTRUCTIONS);
            } else if (StudyNS.global_state == StudyNS.state.INSTRUCTIONS) {
                //transition to study state
                hideState(StudyNS.state.INSTRUCTIONS);
                StudyNS.global_state = StudyNS.state.STUDY;
                showState(StudyNS.state.STUDY);
            } else if (StudyNS.global_state == StudyNS.state.STUDY) {
                //modify and add a little more complex logic to transition between different IFRAME pages
                hideState(StudyNS.state.STUDY);
                StudyNS.global_state = StudyNS.state.QUESTIONNAIRE;
                showState(StudyNS.state.QUESTIONNAIRE);
            } else if (StudyNS.global_state == StudyNS.state.QUESTIONNAIRE) {
                log("currentRound: " + StudyNS.currentRound);
                //iFrameCount==0 means that it has been reset by the handler in prep for the next round
                if (StudyNS.iFrameCount == 0) {
                    //show the "let's go again content box"
                    hideElement(getQuestionnaireContent());
                    showElement(getLetsGoAgainContent());
                } else {
                    //proceed to result state
                    hideState(StudyNS.state.QUESTIONNAIRE);
                    StudyNS.global_state = StudyNS.state.FINAL;
                    showState(StudyNS.state.FINAL);
                }
            } else if (StudyNS.global_state == StudyNS.state.FINAL) {
                hideState(StudyNS.state.FINAL);
                if (StudyNS.debug) {
                    populateResultStateWithStudyData();
                } else {
                    populateResultStateWithThanks();
                }
                showState(StudyNS.state.RESULT);
            }
        }

        function showElement(element) {
            element.style.display = "";
        }

        function hideElement(element) {
            element.style.display = "none";
        }

        function getGoButton() {
            return document.getElementById("go-btn");
        }

        function getDiffDescTextArea() {
            return document.getElementById("diff-desc-textarea");
        }

        function getFinalContent() {
            return document.getElementById("final-content");
        }

        function getDiffDescContent() {
            return document.getElementById("diff-desc-content");
        }

        function getQuestionnaireContent() {
            return document.getElementById("questionnaire-content");
        }

        function getLetsGoAgainContent() {
            return document.getElementById("lets-go-again-content");
        }

        function hideState(state) {
            document.getElementById(state).classList.remove("current-state");
            document.getElementById(state).classList.add("background-state");
        }

        function showState(state) {
            document.getElementById(state).classList.remove("background-state");
            document.getElementById(state).classList.add("current-state");
        }

        function showModal() {
            hideElement(getStudyContentElement());
            //start loading the iFrame
            getMyIFrame(StudyNS.iFrameCount).setAttribute("src", StudyNS.pages[StudyNS.iFrameCount][StudyNS.currentRound]);
            //setup query content
            addQueryContent();
            showElement(getModalElement());
        }

        function addQueryContent() {
            //gets the search query from the iframe search box and fills it in the modal
            document.getElementById("query").innerHTML = getNextPageData().query;
        }

        function hideModal() {
            hideElement(getModalElement());
            showElement(getStudyContentElement());
        }

        function getModalElement() {
            return document.getElementById("pre-study-content");
        }

        function getStudyContentElement() {
            return document.getElementById("study-content");
        }

        function populateResultStateWithThanks() {
            // var thanksNode = document.createElement("h2");
            // thanksNode.appendChild(document.createTextNode("Thanks for being part of this study"));
            // document.getElementById("result-content").appendChild(thanksNode);
            //add browser detection and OS information
            StudyNS.studyData.clientInfo.userAgent = window.navigator.userAgent;
            StudyNS.studyData.clientInfo.screenHeight = window.screen.height;
            StudyNS.studyData.clientInfo.screenWidth = window.screen.width;
            StudyNS.studyData.clientInfo.browserHeight = document.documentElement.clientWidth;
            StudyNS.studyData.clientInfo.browserWidth = document.documentElement.clientHeight;

            document.getElementById('surveyData').value =  JSON.stringify(StudyNS.studyData, function(key, value) {
                return key != "clickedElement" ? value : undefined;
            });
            var resultForm = document.getElementById("result-content");
            showElement(resultForm);

        }

        function populateResultStateWithStudyData() {
            var studyDataString = JSON.stringify(StudyNS.studyData, function(key, value) {
                return key != "clickedElement" ? value : undefined;
            },/* indent length */10);
            var textNode = document.createTextNode(studyDataString);
            var pElement = document.createElement("p");
            pElement.style.whiteSpace = "pre";
            pElement.appendChild(textNode);
            document.getElementById("result").appendChild(pElement);
        }

        function loadAllIFrames() {
            while (StudyNS.currentRound < StudyNS.maxRounds) {
                loadAllIFramesForThisRound();
                StudyNS.currentRound++;
            }
            //reset current round
            StudyNS.currentRound = 0;
        }

        function setIFrameZoom(iFrameElement){
         var newHeightPercent = (10000/StudyNS.zoom);
         var newWidthPercent = (10000/StudyNS.zoom);
         iFrameElement.style.height = newHeightPercent+"%";
         iFrameElement.style.width = newWidthPercent+"%";
         var transformValue = "scale("+(StudyNS.zoom/100)+")";
         var transformOriginValue = "unset";
         iFrameElement.style.top = ((100-newHeightPercent)/2)+"%";
         iFrameElement.style.left = ((100-newWidthPercent)/2)+"%";
         // standard transform style
         iFrameElement.style.transform = transformValue;
         iFrameElement.style["transform-origin"] = transformOriginValue;
         // webkit
         iFrameElement.style["-webkit-transform"] = transformValue;
         iFrameElement.style["-webkit-transform-origin"] = transformOriginValue;
         // moz
         iFrameElement.style["-moz-transform"] = transformValue;
         iFrameElement.style["-moz-transform-origin"] = transformOriginValue;
         // ms
         iFrameElement.style["-ms-transform"] = transformValue;
         iFrameElement.style["-ms-transform-origin"] = transformOriginValue;
        }

        function loadAllIFramesForThisRound() {
            for (var page = 0; page < StudyNS.pages.length; ++page) {
                //create new iframe element for current page source
                var newIFrame = document.createElement("iframe");
                //new iframe id logic
                newIFrame.id = getIFrameIdFromIndex(page);
                //set the iframe in sandbox
                // newIFrame.setAttribute("sandbox","allow-same-origin");
                var iFrameSrc = StudyNS.pages[page][StudyNS.currentRound];
                hideIFrame(newIFrame);
                newIFrame.classList.add("iframe");
                //initialize new PageData for new iframe and append to study Data
                initPageData(iFrameSrc);

                var iFrameParent = document.getElementById("iframe-parent");
                iFrameParent.appendChild(newIFrame);
            }
        }

        //get iframe id from index logic
        function getIFrameIdFromIndex(index) {
            return "iframe_" + StudyNS.currentRound + "_" + index;
        }
        //display the given IFrame
        function showIFrame(iFrame) {
            setIFrameZoom(iFrame);
            iFrame.style.display = "block";
        }

        //hide the given IFrame
        function hideIFrame(iFrame) {
            iFrame.setAttribute("style", "display: none");
        }

        //hides the current iframe and transitions to the next one
        function transitionToNextIFrame() {
            hideModal();
            if (StudyNS.iFrameCount < StudyNS.pages.length) {
                if (StudyNS.iFrameCount != 0) {
                    hideIFrame(getMyIFrame(StudyNS.iFrameCount - 1));
                }
                showIFrame(getMyIFrame(StudyNS.iFrameCount));
                StudyNS.iFrameCount++;
                //must be done after iFrameCount is incremented because of getCurrentPageData logic
                updateStartTimeInCurrentPageData();
            }
        }

        function updateStartTimeInCurrentPageData() {
            var currentPageData = getCurrentPageData();
            currentPageData.timeTakenMS = getTimestamp();
        }

        function updateEndTimeInCurrentPageData(endTime) {
            var currentPageData = getCurrentPageData();
            currentPageData.timeTakenMS = endTime - currentPageData.timeTakenMS;
        }

        function initPageData(src) {
            var queryProperties = getPropertiesFromUrl(src);
            //setting everything except clickData, maxScrollDistance and time taken both of which aren't available yet
            var pg = new PageData(queryProperties.query, queryProperties.vCap,
                                  queryProperties.topAds,/* click data */ null,
                                  /* max scroll distance */ 0, /* time taken */ -1,
                                  /* currentRound + 1 because it is zero indexed*/ StudyNS.currentRound + 1);

            StudyNS.studyData.roundData[StudyNS.currentRound].push(pg);
        }

        function setupIFrameWrapperDimensions() {
            var wrapperElement = document.getElementById('iframe-wrapper');
            wrapperElement.style.height = StudyNS.phoneScreenDimensions.height + "px";
            wrapperElement.style.width = StudyNS.phoneScreenDimensions.width + "px";
        }

        //returns the iframe at the specified index (according to pages) if an index is specified
        // or else returns the currently active iframe
        function getMyIFrame(index) {
            var id;
            if (index != undefined) {
                id = getIFrameIdFromIndex(index);
            } else {
                id = getIFrameIdFromIndex(StudyNS.iFrameCount);
            }
            return document.getElementById(id);
        }

        function updateMaxScrollDistanceInCurrentPageData(maxScrollDistance){
          var currentPageData = getCurrentPageData();
          currentPageData.maxScrollDistance = maxScrollDistance;
        }

        function resultElementActions(contentType, contentPosition, element, endTime, maxScrollDistance) {
            //transition to next iframe
            recordClickDataInCurrentPageData(contentType, contentPosition, element);
            updateEndTimeInCurrentPageData(endTime);
            updateMaxScrollDistanceInCurrentPageData(maxScrollDistance);

            if (StudyNS.iFrameCount < StudyNS.pages.length) {
                //show modal also takes care of hiding the study-content box
                showModal();
            } else {
                // hide current iframe and show modal
                hideIFrame(getMyIFrame(StudyNS.iFrameCount - 1));
                StudyNS.currentRound++; //increment to next round
                if (StudyNS.currentRound < StudyNS.maxRounds) {
                    //let's now go again
                    log("Round : " + (StudyNS.currentRound + 1));
                    StudyNS.iFrameCount = 0;
                    transitionToNextState();
                    showModal();
                } else {
                    //just for the sake of logic (so remember that at the end the iframe count will always be +1 than pages.length)
                    StudyNS.iFrameCount++;
                    //no more pages to display move to next state
                    transitionToNextState();
                }
            }
        }

        //returns an integer timestamp
        function getTimestamp() {
            return +(new Date());
        }

        //This will record new clickData for current page
        function recordClickDataInCurrentPageData(contentType, contentPosition, element) {
            var currentPageData = getCurrentPageData();
            currentPageData.clickData = new ClickData(contentType, contentPosition, element);
        }

        function getCurrentPageData() {
          return StudyNS.studyData.roundData[StudyNS.currentRound][StudyNS.iFrameCount - 1];
        }

        function getNextPageData() {
         return StudyNS.studyData.roundData[StudyNS.currentRound][StudyNS.iFrameCount];
        }
    </script>
</body>

</html>
